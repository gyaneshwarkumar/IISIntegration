<Project>

  <PropertyGroup>
    <RuntimeIdentifiers>win7-x64;win7-x86</RuntimeIdentifiers>
    <Platforms>x64;x86</Platforms>
    <IISExpressAppHostConfig>$(MSBuildThisFileDirectory)applicationhost.config</IISExpressAppHostConfig>
    <IISAppHostConfig>$(MSBuildThisFileDirectory)applicationhost.iis.config</IISAppHostConfig>
    <NativePlatform Condition="'$(Platform)' == 'AnyCPU'">x64</NativePlatform>
    <NativePlatform Condition="'$(NativePlatform)' == ''">$(Platform)</NativePlatform>
  </PropertyGroup>

  <ItemGroup Condition="'$(OS)' == 'Windows_NT'">
    <None Include="$(MSBuildThisFileDirectory)..\src\RequestHandler\bin\$(Configuration)\$(NativeFolder)\aspnetcorerh.dll" CopyToOutputDirectory="PreserveNewest" Visible="true" Link="$(NativePlatform)\%(FileName)%(Extension)" />
    <None Include="$(MSBuildThisFileDirectory)..\src\RequestHandler\bin\$(Configuration)\$(NativeFolder)\aspnetcorerh.pdb" CopyToOutputDirectory="PreserveNewest" Visible="true" Link="$(NativePlatform)\%(FileName)%(Extension)" />
    <None Include="$(MSBuildThisFileDirectory)..\src\AspNetCore\bin\$(Configuration)\$(NativeFolder)\aspnetcore.dll" CopyToOutputDirectory="PreserveNewest" Visible="true" Link="$(NativePlatform)\%(FileName)%(Extension)" />
    <None Include="$(MSBuildThisFileDirectory)..\src\AspNetCore\bin\$(Configuration)\$(NativeFolder)\aspnetcore.pdb" CopyToOutputDirectory="PreserveNewest" Visible="true" Link="$(NativePlatform)\%(FileName)%(Extension)" />
  </ItemGroup>

  <PropertyGroup Condition="'$(NativePlatform)' == 'x86'">
    <IISExpressPath>$(MSBuildProgramFiles32)\IIS Express\iisexpress.exe</IISExpressPath>
    <IISPath>$(SystemRoot)\SysWOW64\inetsrv\w3wp.exe</IISPath>
    <NativeFolder>Win32</NativeFolder>
  </PropertyGroup>

  <PropertyGroup Condition="'$(NativePlatform)' == 'x64'">
    <IISExpressPath>$(ProgramW6432)\IIS Express\iisexpress.exe</IISExpressPath>
    <IISPath>$(SystemRoot)\System32\inetsrv\w3wp.exe</IISPath>
    <NativeFolder>x64</NativeFolder>
  </PropertyGroup>

  <PropertyGroup>
    <IISExpressArguments>/config:"$(IISExpressAppHostConfig)"</IISExpressArguments>
    <IISArguments>-h "$(IISAppHostConfig)"</IISArguments>

    <AncmPath>$(NativePlatform)\aspnetcore.dll</AncmPath>
    <AncmRHPath>$(NativePlatform)\aspnetcorerh.dll</AncmRHPath>
    <DotNetPath>$(userprofile)\.dotnet\$(NativePlatform)\dotnet.exe</DotNetPath>
  </PropertyGroup>

  <Target Name="CopyLaunchSettings" AfterTargets="CoreBuild">
    <!-- This would always override launch settings files in test projects by the default one -->
    <Copy SourceFiles="$(MSBuildThisFileDirectory)launchSettings.json" DestinationFolder="$(MSBuildProjectDirectory)\Properties" />
  </Target>

  <PropertyGroup>
    <TestTargetsAssembly>$(MSBuildThisFileDirectory)..\test\TestTasks\bin\$(Configuration)\netstandard2.0\TestTasks.dll</TestTargetsAssembly>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="$(MSBuildThisFileDirectory)..\test\TestTasks\TestTasks.csproj">
       <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
       <BuildReference Condition="Exists('$(TestTargetsAssembly)')">False</BuildReference>
    </ProjectReference>
  </ItemGroup>

  <UsingTask TaskName="InjectRequestHandler" AssemblyFile="$(TestTargetsAssembly)" />

  <Target Name="InjectRequestHandler" AfterTargets="GenerateBuildDependencyFile">
    <InjectRequestHandler DepsFile="$(ProjectDepsFilePath)" Rid="win7-$(NativePlatform)" LibraryLocation="$(AncmRHPath)" />
  </Target>

  <Target Name="InjectRequestHandlerOnPublish" AfterTargets="GeneratePublishDependencyFile">
    <InjectRequestHandler DepsFile="$(PublishDepsFilePath)" Rid="win7-$(NativePlatform)" LibraryLocation="$(AncmRHPath)" />
  </Target>

</Project>
